{% extends "base.html" %}
{% block title %}Request Detail â€” DGSpace{% endblock %}

{% block content %}
<div style="max-width:860px;margin:0 auto">

  <!-- Back link -->
  <a href="/print-requests/" style="color:#888;font-size:0.9rem;text-decoration:none">â† Back to list</a>

  <div id="loading-detail" style="text-align:center;padding:60px;color:#888">Loadingâ€¦</div>

  <!-- Main detail card (hidden until data loads) -->
  <div id="detail-card" style="display:none">

    <!-- Header row -->
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin:16px 0 20px">
      <div>
        <h2 id="d-project-name" style="margin:0 0 6px"></h2>
        <span id="d-status-badge"></span>
        <span id="d-priority-badge" style="margin-left:6px"></span>
      </div>
      <div style="text-align:right;font-size:0.85rem;color:#888">
        <div>Submitted: <span id="d-created-at"></span></div>
        <div id="d-reviewed-row" style="display:none">Reviewed: <span id="d-reviewed-at"></span></div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">

      <!-- Left: details -->
      <div class="card" style="margin:0">
        <h3 style="margin:0 0 16px;font-size:1rem;color:#444">Request Details</h3>
        <table style="width:100%;border-collapse:collapse;font-size:0.9rem">
          <tr><td style="padding:6px 0;color:#888;width:44%">Material</td>      <td id="d-material"></td></tr>
          <tr><td style="padding:6px 0;color:#888">Color</td>                   <td id="d-color"></td></tr>
          <tr><td style="padding:6px 0;color:#888">Est. Weight</td>             <td id="d-weight"></td></tr>
          <tr><td style="padding:6px 0;color:#888">Est. Print Time</td>         <td id="d-time"></td></tr>
          <tr><td style="padding:6px 0;color:#888">Submitted by</td>            <td id="d-student"></td></tr>
          <tr id="d-email-row" style="display:none"><td style="padding:6px 0;color:#888">Student Email</td>  <td><a id="d-student-email" href="#" style="color:#e94560;font-size:0.9rem"></a></td></tr>
        </table>

        <div id="d-description-block" style="margin-top:16px;display:none">
          <div style="font-size:0.85rem;color:#888;margin-bottom:4px">Description</div>
          <div id="d-description" style="font-size:0.9rem;color:#333;white-space:pre-wrap"></div>
        </div>

        <div id="d-admin-notes-block" style="margin-top:16px;padding:12px 14px;background:#fff8e1;border:1px solid #ffe082;border-radius:6px;display:none;white-space:normal;overflow-wrap:anywhere;word-break:break-word">
          <div style="font-size:0.85rem;font-weight:600;color:#7a5800;margin-bottom:4px">âš ï¸ Admin Feedback</div>
          <div id="d-admin-notes" style="font-size:0.9rem;color:#7a5800"></div>
          <div id="d-admin-notes-hint" style="margin-top:8px;font-size:0.8rem;color:#999;display:none">
            Please address the feedback above, then delete this request and submit a new one.
          </div>
        </div>

        <!-- STL Analysis -->
        <div id="d-analysis-block" style="margin-top:16px;padding:12px 14px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:6px;display:none">
          <div style="font-size:0.85rem;font-weight:600;color:#166534;margin-bottom:8px">ğŸ“Š STL Analysis</div>
          <table style="width:100%;font-size:0.85rem;border-collapse:collapse">
            <tr>
              <td style="padding:3px 0;color:#555;width:40%">Volume</td>
              <td id="d-a-volume" style="font-weight:500"></td>
            </tr>
            <tr>
              <td style="padding:3px 0;color:#555">Dimensions</td>
              <td id="d-a-bbox" style="font-weight:500"></td>
            </tr>
            <tr>
              <td style="padding:3px 0;color:#555">Est. Weight</td>
              <td id="d-a-weight" style="font-weight:500"></td>
            </tr>
            <tr>
              <td style="padding:3px 0;color:#555">Est. Print Time</td>
              <td id="d-a-time" style="font-weight:500"></td>
            </tr>
          </table>
          <div style="margin-top:8px;font-size:0.85rem;color:#555">
            <span style="font-weight:500">Infill:</span> <span id="d-infill-display" style="font-weight:600">20</span>%
          </div>
          <div style="margin-top:6px;font-size:0.78rem;color:#888">âš ï¸ Estimates are approximate. Actual values depend on slicer settings.</div>
        </div>
      </div>

      <!-- Right: STL viewer -->
      <div class="card" style="margin:0;padding:0;overflow:hidden;position:relative">
        <!-- No STL placeholder -->
        <div id="stl-placeholder" style="height:320px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#bbb;gap:8px">
          <svg width="48" height="48" fill="none" stroke="#ddd" stroke-width="1.2" viewBox="0 0 24 24">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
          </svg>
          <span style="font-size:0.85rem">No STL file attached</span>
        </div>

        <!-- Three.js canvas container -->
        <div id="stl-viewer-wrap" style="display:none;position:relative">
          <canvas id="stl-canvas" style="width:100%;height:320px;display:block"></canvas>
          <!-- Controls hint -->
          <div style="position:absolute;bottom:8px;right:10px;font-size:0.72rem;color:#aaa;pointer-events:none">
            ğŸ–± Drag to rotate Â· Scroll to zoom
          </div>
          <!-- Loading spinner while STL parses -->
          <div id="stl-loading" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.85);font-size:0.85rem;color:#888">
            Loading 3D modelâ€¦
          </div>
          <!-- Download link -->
          <a id="stl-download" href="#" download
             style="position:absolute;top:8px;right:10px;font-size:0.75rem;color:#007bff;text-decoration:none;background:rgba(255,255,255,0.9);padding:3px 8px;border-radius:4px">
            â¬‡ Download STL
          </a>
        </div>
      </div>

    </div><!-- /grid -->

    <!-- â•â•â•â•â•â• Admin Actions (below the grid) â•â•â•â•â•â• -->
    <div id="admin-actions" style="display:none;margin-top:24px">
      <div class="card" style="margin:0">
        <h3 style="margin:0 0 16px;font-size:1rem;color:#444">ğŸ›  Admin Actions</h3>
        <div id="admin-alert-box"></div>

        <!-- Status info for non-pending -->
        <div id="admin-status-info" style="display:none;font-size:0.9rem;color:#555"></div>

        <!-- Action buttons (shown for pending / revision_requested) -->
        <div id="admin-btn-group" style="display:none;display:flex;gap:12px;flex-wrap:wrap">
          <button id="btn-approve" class="btn" onclick="adminApprove()"
                  style="width:auto;padding:10px 24px;background:#28a745;font-size:0.95rem">
            âœ… Approve â€” Ready to Print
          </button>
          <button id="btn-reject" class="btn" onclick="adminReject()"
                  style="width:auto;padding:10px 24px;background:#dc3545;font-size:0.95rem">
            âŒ Reject
          </button>
          <button id="btn-feedback-toggle" class="btn" onclick="toggleFeedbackForm()"
                  style="width:auto;padding:10px 24px;background:#f39c12;font-size:0.95rem">
            ğŸ’¬ Send Feedback
          </button>
        </div>

        <!-- Inline feedback form (hidden by default) -->
        <div id="feedback-form" style="display:none;margin-top:16px">
          <label style="font-weight:600;font-size:0.9rem;color:#333;display:block;margin-bottom:6px">
            Feedback for Student <span style="color:#e94560">*</span>
          </label>
          <p style="font-size:0.82rem;color:#888;margin:0 0 8px">
            The student will see this message. Explain what needs to be changed.
          </p>
          <textarea id="feedback-text" rows="4" placeholder="e.g. The STL file has non-manifold geometry. Please repair and re-uploadâ€¦"
                    style="width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:0.9rem;resize:vertical;font-family:inherit"></textarea>
          <div style="display:flex;gap:10px;margin-top:12px;justify-content:flex-end">
            <button class="btn" onclick="toggleFeedbackForm()" style="width:auto;padding:8px 18px;background:#6c757d">Cancel</button>
            <button id="btn-send-feedback" class="btn" onclick="adminSendFeedback()" style="width:auto;padding:8px 18px;background:#f39c12">ğŸ’¬ Send Feedback</button>
          </div>
        </div>

        <!-- Status update buttons for in_progress -->
        <div id="admin-progress-group" style="display:none;margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
          <button class="btn" onclick="adminSetStatus('completed')"
                  style="width:auto;padding:10px 24px;background:#28a745;font-size:0.95rem">
            âœ… Mark Completed
          </button>
          <button class="btn" onclick="adminSetStatus('cancelled')"
                  style="width:auto;padding:10px 24px;background:#6c757d;font-size:0.95rem">
            ğŸš« Cancel
          </button>
        </div>
      </div>
    </div>

  </div><!-- /detail-card -->
</div>

<!-- Three.js + STLLoader via CDN (importmap) -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { STLLoader }     from 'three/addons/loaders/STLLoader.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

// â”€â”€ helpers (from base.html, already in window scope) â”€â”€â”€â”€â”€â”€
const requestId = parseInt(location.pathname.split('/').filter(Boolean).pop());

// â”€â”€ fetch request data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDetail() {
  try {
    const res  = await window.apiFetch(`/api/print-requests/${requestId}`);
    if (res.status === 401) { location.href = '/accounts/login'; return; }
    const data = await res.json();

    if (!data.success) {
      document.getElementById('loading-detail').textContent = 'Request not found.';
      return;
    }

    renderDetail(data.request);
  } catch(e) {
    document.getElementById('loading-detail').textContent = 'Failed to load. Is the backend running?';
  }
}

function statusBadge(s) {
  const map = { pending:'Pending', approved:'Approved', rejected:'Rejected',
                in_progress:'In Progress', completed:'Completed', cancelled:'Cancelled',
                revision_requested:'Revision Requested' };
  return `<span class="badge badge-${s}">${map[s] || s}</span>`;
}
function priorityLabel(p) {
  return p === 'urgent' ? '<span style="color:#dc3545">ğŸ”´ Urgent</span>'
       : p === 'high'   ? '<span style="color:#fd7e14">ğŸŸ  High</span>'
                        : '<span style="color:#28a745">ğŸŸ¢ Normal</span>';
}

function renderDetail(r) {
  document.getElementById('loading-detail').style.display = 'none';
  document.getElementById('detail-card').style.display    = 'block';

  document.getElementById('d-project-name').textContent = r.project_name;
  document.getElementById('d-status-badge').innerHTML    = statusBadge(r.status);
  document.getElementById('d-priority-badge').innerHTML  = priorityLabel(r.priority);
  document.getElementById('d-created-at').textContent    = new Date(r.created_at).toLocaleDateString('en-US');
  document.getElementById('d-material').textContent      = r.material_type || 'â€”';
  document.getElementById('d-color').textContent         = r.color_preference || 'â€”';
  document.getElementById('d-weight').textContent        = r.estimated_weight_grams ? r.estimated_weight_grams + ' g' : 'â€”';
  document.getElementById('d-time').textContent          = r.estimated_print_time_hours ? r.estimated_print_time_hours + ' h' : 'â€”';
  document.getElementById('d-student').textContent       = r.student_name || r.student_email || 'â€”';

  // Show student email only to admins
  const currentUser = window.getUser ? window.getUser() : null;
  if (currentUser && currentUser.user_type === 'admin' && r.student_email) {
    const emailEl = document.getElementById('d-student-email');
    emailEl.textContent = r.student_email;
    emailEl.href = `mailto:${r.student_email}`;
    document.getElementById('d-email-row').style.display = '';
  }

  if (r.description) {
    document.getElementById('d-description').textContent = r.description;
    document.getElementById('d-description-block').style.display = 'block';
  }
  if (r.admin_notes) {
    document.getElementById('d-admin-notes').textContent = r.admin_notes;
    document.getElementById('d-admin-notes-block').style.display = 'block';
    const user = window.getUser ? window.getUser() : null;
    if (user && user.user_type !== 'admin') {
      document.getElementById('d-admin-notes-hint').style.display = 'block';
    }
  }
  if (r.reviewed_at) {
    document.getElementById('d-reviewed-at').textContent = new Date(r.reviewed_at).toLocaleDateString('en-US');
    document.getElementById('d-reviewed-row').style.display = 'block';
  }

  // STL viewer
  if (r.stl_file_path) {
    const stlUrl = `/api/uploads/${r.stl_file_path}`;
    document.getElementById('stl-placeholder').style.display  = 'none';
    document.getElementById('stl-viewer-wrap').style.display  = 'block';
    document.getElementById('stl-download').href              = stlUrl;
    document.getElementById('stl-download').download          = r.stl_original_name || r.stl_file_path;
    initViewer(stlUrl);

    // Store for re-analysis
    window._detailStlFile = r.stl_file_path;
    window._detailMaterial = r.material_type || 'PLA';

    // Fetch live STL analysis
    fetchAnalysis(r.stl_file_path, r.material_type || 'PLA', 0.20);
  }

  // â”€â”€ Admin actions panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (currentUser && currentUser.user_type === 'admin') {
    document.getElementById('admin-actions').style.display = 'block';
    window._currentRequestId = r.id || requestId;
    window._currentStatus = r.status;

    const btnGroup      = document.getElementById('admin-btn-group');
    const progressGroup = document.getElementById('admin-progress-group');
    const statusInfo    = document.getElementById('admin-status-info');

    // Reset visibility
    btnGroup.style.display      = 'none';
    progressGroup.style.display = 'none';
    statusInfo.style.display    = 'none';

    if (r.status === 'pending' || r.status === 'revision_requested') {
      btnGroup.style.display = 'flex';
    } else if (r.status === 'approved' || r.status === 'in_progress') {
      progressGroup.style.display = 'flex';
    } else {
      statusInfo.style.display = 'block';
      const labels = { completed: 'âœ… Completed', rejected: 'âŒ Rejected', cancelled: 'ğŸš« Cancelled' };
      statusInfo.innerHTML = `<span style="font-size:1rem">${labels[r.status] || r.status}</span> â€” No further actions available.`;
    }
  }
}

async function fetchAnalysis(filename, material, infill) {
  try {
    const res = await window.apiFetch(
      `/api/print-requests/analyze-stl/${encodeURIComponent(filename)}?material=${encodeURIComponent(material)}&infill=${infill}`
    );
    const data = await res.json();
    if (data.success && data.analysis) {
      const a = data.analysis;
      document.getElementById('d-a-volume').textContent = a.volume_cm3 + ' cmÂ³';
      document.getElementById('d-a-weight').textContent = a.estimated_weight_grams + ' g';
      document.getElementById('d-a-time').textContent   = a.estimated_print_time_hours + ' h';
      document.getElementById('d-infill-display').textContent = a.infill_percent;
      const bb = a.bounding_box;
      document.getElementById('d-a-bbox').textContent   = bb.x_mm + ' Ã— ' + bb.y_mm + ' Ã— ' + bb.z_mm + ' mm';
      document.getElementById('d-analysis-block').style.display = 'block';
    }
  } catch(e) {
    // Analysis is optional â€” silently ignore errors
  }
}

// â”€â”€ Three.js STL viewer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initViewer(stlUrl) {
  const canvas = document.getElementById('stl-canvas');
  const wrap   = document.getElementById('stl-viewer-wrap');

  // Renderer
  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setClearColor(0xf8f9fa, 1);

  function resize() {
    const w = wrap.clientWidth;
    const h = 320;
    renderer.setSize(w, h, false);
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
  }

  // Camera
  const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 10000);
  camera.position.set(0, 0, 200);

  // Scene + lights
  const scene = new THREE.Scene();
  const ambient = new THREE.AmbientLight(0xffffff, 0.6);
  const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
  dirLight.position.set(1, 2, 3);
  scene.add(ambient, dirLight);

  // OrbitControls
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.08;

  // Load STL
  const loader = new STLLoader();
  loader.load(
    stlUrl,
    (geometry) => {
      // Hide loading overlay
      document.getElementById('stl-loading').style.display = 'none';

      geometry.computeBoundingBox();
      const box    = geometry.boundingBox;
      const center = new THREE.Vector3();
      box.getCenter(center);
      const size   = new THREE.Vector3();
      box.getSize(size);
      const maxDim = Math.max(size.x, size.y, size.z);

      // Center the geometry
      geometry.translate(-center.x, -center.y, -center.z);

      const material = new THREE.MeshPhongMaterial({
        color: 0x4a90d9,
        specular: 0x222222,
        shininess: 40,
        side: THREE.DoubleSide,
      });
      const mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);

      // Fit camera
      const dist = maxDim * 1.6;
      camera.position.set(dist * 0.6, dist * 0.4, dist);
      camera.near = dist * 0.001;
      camera.far  = dist * 100;
      camera.updateProjectionMatrix();
      controls.target.set(0, 0, 0);
      controls.update();

      resize();
    },
    undefined,
    (err) => {
      document.getElementById('stl-loading').textContent = 'Failed to load 3D model.';
      console.error(err);
    }
  );

  // Resize observer
  new ResizeObserver(resize).observe(wrap);
  resize();

  // Render loop
  (function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  })();
}

// â”€â”€ Admin action functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Expose to global scope so onclick handlers in HTML can call them
window.adminApprove = adminApprove;
window.adminReject = adminReject;
window.adminSetStatus = adminSetStatus;
window.toggleFeedbackForm = toggleFeedbackForm;
window.adminSendFeedback = adminSendFeedback;

function adminShowAlert(msg, type='error') {
  document.getElementById('admin-alert-box').innerHTML =
    `<div class="alert alert-${type}">${msg}</div>`;
}

async function adminApprove() {
  if (!confirm('Approve this request and mark it as ready to print?')) return;
  await adminSetStatus('approved');
}

async function adminReject() {
  if (!confirm('Reject this request?')) return;
  await adminSetStatus('rejected');
}

async function adminSetStatus(newStatus) {
  try {
    const res = await window.apiFetch(`/api/admin/print-requests/${window._currentRequestId}/status`, {
      method: 'PATCH',
      body: JSON.stringify({ status: newStatus })
    });
    const data = await res.json();
    if (data.success) {
      adminShowAlert(`Status updated to "${newStatus}". Reloadingâ€¦`, 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      adminShowAlert(data.message || 'Failed to update status.');
    }
  } catch(e) {
    adminShowAlert('Network error. Make sure the backend is running.');
  }
}

function toggleFeedbackForm() {
  const form = document.getElementById('feedback-form');
  const btnGroup = document.getElementById('admin-btn-group');
  if (form.style.display === 'none') {
    form.style.display = 'block';
    btnGroup.style.display = 'none';
    document.getElementById('feedback-text').focus();
  } else {
    form.style.display = 'none';
    btnGroup.style.display = 'flex';
  }
}

async function adminSendFeedback() {
  const reason = document.getElementById('feedback-text').value.trim();
  if (!reason) {
    adminShowAlert('Please enter feedback before sending.');
    document.getElementById('feedback-text').focus();
    return;
  }

  const btn = document.getElementById('btn-send-feedback');
  btn.disabled = true;
  btn.textContent = 'Sendingâ€¦';

  try {
    const res = await window.apiFetch(`/api/admin/print-requests/${window._currentRequestId}/return`, {
      method: 'POST',
      body: JSON.stringify({ reason })
    });
    const data = await res.json();
    if (data.success) {
      adminShowAlert('Feedback sent successfully. Reloadingâ€¦', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      adminShowAlert(data.message || 'Failed to send feedback.');
      btn.disabled = false;
      btn.textContent = 'ğŸ’¬ Send Feedback';
    }
  } catch(e) {
    adminShowAlert('Network error. Make sure the backend is running.');
    btn.disabled = false;
    btn.textContent = 'ğŸ’¬ Send Feedback';
  }
}

loadDetail();
</script>
{% endblock %}
