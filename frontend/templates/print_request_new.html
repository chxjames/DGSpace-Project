{% extends "base.html" %}
{% block title %}New Print Request â€” DGSpace{% endblock %}

{% block content %}
<div class="card" style="max-width:560px;margin:0 auto">
  <h2>â• Submit a 3D Print Request</h2>
  <p style="color:#666;margin-bottom:20px;font-size:0.9rem">Fill in the details below. An admin will review and follow up on your request.</p>

  <div id="alert-box"></div>

  <div class="form-group">
    <label>Project Name *</label>
    <input type="text" id="project_name" placeholder="e.g. Graduation project base">
  </div>
  <div class="form-group">
    <label>Description</label>
    <textarea id="description" placeholder="Dimensions, purpose, special notesâ€¦"></textarea>
  </div>
  <div class="form-group">
    <label>Material</label>
    <select id="material_type">
      <option value="PLA">PLA (Recommended, easy to print)</option>
      <option value="ABS">ABS (Stronger, requires ventilation)</option>
      <option value="PETG">PETG (Flexible and heat-resistant)</option>
      <option value="TPU">TPU (Flexible material)</option>
      <option value="Resin">Resin (High precision)</option>
    </select>
  </div>
  <div class="form-group">
    <label>Color Preference</label>
    <input type="text" id="color_preference" placeholder="White, Black, Anyâ€¦">
  </div>
  <div style="display:flex;gap:12px">
    <div class="form-group" style="flex:1">
      <label>Est. Weight (g)</label>
      <input type="number" id="estimated_weight_grams" min="1" placeholder="50">
    </div>
    <div class="form-group" style="flex:1">
      <label>Est. Print Time (h)</label>
      <input type="number" id="estimated_print_time_hours" min="0.5" step="0.5" placeholder="2">
    </div>
  </div>
  <div class="form-group">
    <label>Priority</label>
    <select id="priority">
      <option value="normal">ğŸŸ¢ Normal</option>
      <option value="high">ğŸŸ  High</option>
      <option value="urgent">ğŸ”´ Urgent</option>
    </select>
  </div>

  <div class="form-group">
    <label>STL File <span style="color:#888;font-weight:400">(optional)</span></label>
    <div id="stl-drop-zone" style="
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 24px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.2s, background 0.2s;
      "
      onclick="document.getElementById('stl-file-input').click()"
      ondragover="event.preventDefault(); this.style.borderColor='#007bff'; this.style.background='#f0f7ff';"
      ondragleave="this.style.borderColor='#ccc'; this.style.background='';"
      ondrop="handleDrop(event)">
      <div id="stl-drop-label">
        <svg width="32" height="32" fill="none" stroke="#aaa" stroke-width="1.5" viewBox="0 0 24 24" style="margin-bottom:8px">
          <path d="M12 16V8m0 0-3 3m3-3 3 3M6 20h12a2 2 0 0 0 2-2V8l-6-6H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2z"/>
        </svg>
        <p style="margin:0;color:#888;font-size:0.9rem">Drag &amp; drop your <strong>.stl</strong> file here, or <span style="color:#007bff">click to browse</span></p>
        <p style="margin:4px 0 0;color:#bbb;font-size:0.8rem">Max 50 MB</p>
      </div>
      <div id="stl-file-selected" style="display:none">
        <p style="margin:0;font-size:0.9rem;color:#333">ğŸ“ <span id="stl-filename-display"></span></p>
        <button type="button" onclick="clearStlFile(event)" style="margin-top:6px;font-size:0.8rem;color:#dc3545;background:none;border:none;cursor:pointer">âœ• Remove</button>
      </div>
    </div>
    <input type="file" id="stl-file-input" accept=".stl" style="display:none" onchange="handleFileSelect(this.files[0])">
    <div id="stl-upload-status" style="margin-top:6px;font-size:0.85rem"></div>
  </div>

  <button class="btn" onclick="doSubmit()">Submit Request</button>
  <a href="/print-requests/" style="display:block;text-align:center;margin-top:12px;font-size:0.9rem">â† Back to List</a>
</div>

<script>
(function() {
  const user = getUser();
  if (!user || user.user_type !== 'student') {
    location.href = '/accounts/login';
  }
})();

// â”€â”€ STL upload state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let uploadedStlFilename = null;   // saved name on server (uuid.stl)
let uploadedStlOriginalName = null;
let autoFilledProjectNameFromStl = false;
let submittedSuccessfully = false;

function deriveProjectNameFromFilename(filename) {
  if (!filename) return '';
  // Strip path if any (some browsers may include fakepath)
  const base = filename.split('\\').pop().split('/').pop();
  // Remove .stl extension
  return base.replace(/\.stl$/i, '').trim();
}

function maybeAutoFillProjectNameFromStl(originalName) {
  const input = document.getElementById('project_name');
  if (!input) return;

  // Only auto-fill when empty or when we previously auto-filled it.
  if (input.value.trim() && !autoFilledProjectNameFromStl) return;

  const derived = deriveProjectNameFromFilename(originalName);
  if (!derived) return;

  input.value = derived;
  autoFilledProjectNameFromStl = true;
}

// If the user types, stop auto-overwriting.
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('project_name');
  if (!input) return;
  input.addEventListener('input', () => {
    autoFilledProjectNameFromStl = false;
  });
});

function setStlStatus(msg, color) {
  const el = document.getElementById('stl-upload-status');
  el.textContent = msg;
  el.style.color = color || '#555';
}

function handleDrop(event) {
  event.preventDefault();
  const zone = document.getElementById('stl-drop-zone');
  zone.style.borderColor = '#ccc';
  zone.style.background = '';
  const file = event.dataTransfer.files[0];
  if (file) handleFileSelect(file);
}

function handleFileSelect(file) {
  if (!file) return;
  if (!file.name.toLowerCase().endsWith('.stl')) {
    setStlStatus('Only .stl files are allowed.', '#dc3545');
    return;
  }
  if (file.size > 50 * 1024 * 1024) {
    setStlStatus('File exceeds 50 MB limit.', '#dc3545');
    return;
  }
  uploadStlFile(file);
}

async function uploadStlFile(file) {
  setStlStatus('Uploadingâ€¦', '#888');

  const formData = new FormData();
  formData.append('file', file);

  try {
    const res = await fetch('/api/print-requests/upload-stl', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + getToken() },
      body: formData
    });
    const data = await res.json();

    if (data.success) {
      uploadedStlFilename     = data.filename;
      uploadedStlOriginalName = data.original_name;

      maybeAutoFillProjectNameFromStl(uploadedStlOriginalName);

      document.getElementById('stl-drop-label').style.display   = 'none';
      document.getElementById('stl-file-selected').style.display = 'block';
      document.getElementById('stl-filename-display').textContent = data.original_name;
      setStlStatus('File uploaded successfully.', '#28a745');
    } else {
      setStlStatus(data.message || 'Upload failed.', '#dc3545');
    }
  } catch(e) {
    setStlStatus('Upload failed â€” cannot reach server.', '#dc3545');
  }
}

async function clearStlFile(event) {
  event.stopPropagation();

  const filenameToDelete = uploadedStlFilename;

  // Clear UI state immediately for a snappy UX.
  uploadedStlFilename     = null;
  uploadedStlOriginalName = null;
  autoFilledProjectNameFromStl = false;
  document.getElementById('stl-file-input').value = '';
  document.getElementById('stl-drop-label').style.display   = 'block';
  document.getElementById('stl-file-selected').style.display = 'none';
  setStlStatus('');

  // Best-effort cleanup on the server.
  if (!filenameToDelete) return;
  try {
    await fetch(`/api/print-requests/upload-stl/${encodeURIComponent(filenameToDelete)}`, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + getToken() }
    });
  } catch (e) {
    // If server is unreachable, we still let the user proceed.
  }
}

// â”€â”€ Form submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAlert(msg, type='error') {
  document.getElementById('alert-box').innerHTML =
    `<div class="alert alert-${type}">${msg}</div>`;
}

async function doSubmit() {
  const project_name = document.getElementById('project_name').value.trim();
  if (!project_name) { showAlert('Project name is required.'); return; }

  const body = {
    project_name,
    description:                document.getElementById('description').value.trim(),
    material_type:              document.getElementById('material_type').value,
    color_preference:           document.getElementById('color_preference').value.trim(),
    estimated_weight_grams:     parseFloat(document.getElementById('estimated_weight_grams').value) || null,
    estimated_print_time_hours: parseFloat(document.getElementById('estimated_print_time_hours').value) || null,
    priority:                   document.getElementById('priority').value,
    stl_file_path:              uploadedStlFilename    || null,
    stl_original_name:          uploadedStlOriginalName || null,
  };

  try {
    const res  = await apiFetch('/api/print-requests', { method: 'POST', body: JSON.stringify(body) });
    const data = await res.json();

    if (data.success) {
      submittedSuccessfully = true;
      showAlert('Request submitted successfully!', 'success');
      setTimeout(() => location.href = '/print-requests/', 1200);
    } else {
      showAlert(data.message || 'Submission failed.');
    }
  } catch(e) {
    showAlert('Cannot reach the backend.');
  }
}

// â”€â”€ Best-effort cleanup: if user leaves after uploading but before submitting â”€â”€
window.addEventListener('beforeunload', () => {
  if (submittedSuccessfully) return;
  if (!uploadedStlFilename) return;

  const url = `/api/print-requests/upload-stl/${encodeURIComponent(uploadedStlFilename)}`;

  // Note: Browsers restrict what you can do during unload.
  // We try sendBeacon first; if not supported, fall back to fetch keepalive.
  try {
    if (navigator.sendBeacon) {
      // sendBeacon supports simple payloads; use JSON and backend ignores body.
      // We can't reliably set custom headers in sendBeacon, so this may be a no-op
      // depending on browser. keepalive fetch below often works better.
      navigator.sendBeacon(url, JSON.stringify({}));
    }
  } catch (e) {
    // ignore
  }

  try {
    fetch(url, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + getToken() },
      keepalive: true
    });
  } catch (e) {
    // ignore
  }
});
</script>
{% endblock %}
