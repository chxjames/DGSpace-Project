{% extends "base.html" %}
{% block title %}New Print Request ‚Äî DGSpace{% endblock %}

{% block content %}
<div class="card" style="max-width:560px;margin:0 auto">
  <h2>‚ûï Submit a 3D Print Request</h2>
  <p style="color:#666;margin-bottom:20px;font-size:0.9rem">Fill in the details below. An admin will review and follow up on your request.</p>

  <div id="alert-box"></div>

  <div class="form-group">
    <label>STL File * <span style="color:#888;font-weight:400">(Project name, weight & time will be auto-filled ‚Äî please review before submitting)</span></label>
    <div id="stl-drop-zone" style="
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 24px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.2s, background 0.2s;
      "
      onclick="document.getElementById('stl-file-input').click()"
      ondragover="event.preventDefault(); this.style.borderColor='#007bff'; this.style.background='#f0f7ff';"
      ondragleave="this.style.borderColor='#ccc'; this.style.background='';"
      ondrop="handleDrop(event)">
      <div id="stl-drop-label">
        <svg width="32" height="32" fill="none" stroke="#aaa" stroke-width="1.5" viewBox="0 0 24 24" style="margin-bottom:8px">
          <path d="M12 16V8m0 0-3 3m3-3 3 3M6 20h12a2 2 0 0 0 2-2V8l-6-6H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2z"/>
        </svg>
        <p style="margin:0;color:#888;font-size:0.9rem">Drag &amp; drop your <strong>.stl</strong> file here, or <span style="color:#007bff">click to browse</span></p>
        <p style="margin:4px 0 0;color:#bbb;font-size:0.8rem">Max 50 MB</p>
      </div>
      <div id="stl-file-selected" style="display:none">
        <p style="margin:0;font-size:0.9rem;color:#333">üìé <span id="stl-filename-display"></span></p>
        <button type="button" onclick="clearStlFile(event)" style="margin-top:6px;font-size:0.8rem;color:#dc3545;background:none;border:none;cursor:pointer">‚úï Remove</button>
      </div>
    </div>
    <input type="file" id="stl-file-input" accept=".stl" style="display:none" onchange="handleFileSelect(this.files[0])">
    <div id="stl-upload-status" style="margin-top:6px;font-size:0.85rem"></div>

    <!-- STL Analysis Results -->
    <div id="stl-analysis-card" style="display:none;margin-top:12px;padding:14px 16px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px">
      <div style="font-size:0.85rem;font-weight:600;color:#166534;margin-bottom:8px">üìä STL Analysis</div>
      <table style="width:100%;font-size:0.85rem;border-collapse:collapse">
        <tr>
          <td style="padding:3px 0;color:#555">Volume</td>
          <td id="stl-a-volume" style="font-weight:500"></td>
          <td style="padding:3px 0;color:#555;padding-left:16px">Dimensions</td>
          <td id="stl-a-bbox" style="font-weight:500"></td>
        </tr>
        <tr>
          <td style="padding:3px 0;color:#555">Est. Weight</td>
          <td id="stl-a-weight" style="font-weight:500"></td>
          <td style="padding:3px 0;color:#555;padding-left:16px">Est. Print Time</td>
          <td id="stl-a-time" style="font-weight:500"></td>
        </tr>
        <tr>
          <td style="padding:3px 0;color:#555">Material</td>
          <td id="stl-a-material" style="font-weight:500"></td>
          <td style="padding:3px 0;color:#555;padding-left:16px">Infill</td>
          <td id="stl-a-infill" style="font-weight:500"></td>
        </tr>
      </table>
      <div style="margin-top:6px;font-size:0.78rem;color:#888">‚ö†Ô∏è Estimates are approximate. Actual values depend on slicer settings.</div>
    </div>
  </div>

  <div class="form-group">
    <label>Project Name * <span style="color:#888;font-weight:400">(auto-filled from filename)</span></label>
    <input type="text" id="project_name" placeholder="e.g. Graduation project base">
  </div>
  <div class="form-group">
    <label>Description</label>
    <textarea id="description" placeholder="Dimensions, purpose, special notes‚Ä¶"></textarea>
  </div>
  <div class="form-group">
    <label>Material</label>
    <select id="material_type">
      <option value="PLA">PLA (Recommended, easy to print)</option>
      <option value="ABS">ABS (Stronger, requires ventilation)</option>
      <option value="PETG">PETG (Flexible and heat-resistant)</option>
      <option value="TPU">TPU (Flexible material)</option>
      <option value="Resin">Resin (High precision)</option>
    </select>
  </div>
  <div class="form-group">
    <label>Color Preference</label>
    <input type="text" id="color_preference" placeholder="White, Black, Any‚Ä¶">
  </div>
  <div style="display:flex;gap:12px">
    <div class="form-group" style="flex:1">
      <label>Est. Weight (g) <span style="color:#888;font-weight:400">(auto-filled)</span></label>
      <input type="number" id="estimated_weight_grams" min="1" placeholder="50">
    </div>
    <div class="form-group" style="flex:1">
      <label>Est. Print Time (h) <span style="color:#888;font-weight:400">(auto-filled)</span></label>
      <input type="number" id="estimated_print_time_hours" min="0.5" step="0.5" placeholder="2">
    </div>
  </div>
  <div class="form-group">
    <label>Infill: <span id="infill-display">20</span>%</label>
    <input type="range" id="infill_percent" min="5" max="100" step="5" value="20"
           style="width:100%;accent-color:#e94560"
           oninput="document.getElementById('infill-display').textContent=this.value;"
           onchange="onInfillChange();">
    <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:#aaa;margin-top:2px">
      <span>5%</span><span>Hollow ‚Üí Solid</span><span>100%</span>
    </div>
  </div>
  <div class="form-group">
    <label>Priority</label>
    <select id="priority">
      <option value="normal">üü¢ Normal</option>
      <option value="high">üü† High</option>
      <option value="urgent">üî¥ Urgent</option>
    </select>
  </div>

  <button class="btn" onclick="doSubmit()">Submit Request</button>
  <a href="/print-requests/" style="display:block;text-align:center;margin-top:12px;font-size:0.9rem">‚Üê Back to List</a>
</div>

<script>
(function() {
  const user = getUser();
  if (!user || user.user_type !== 'student') {
    location.href = '/accounts/login';
  }
})();

// ‚îÄ‚îÄ STL upload state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let uploadedStlFilename = null;   // saved name on server (uuid.stl)
let uploadedStlOriginalName = null;
let autoFilledProjectNameFromStl = false;
let submittedSuccessfully = false;

function deriveProjectNameFromFilename(filename) {
  if (!filename) return '';
  // Strip path if any (some browsers may include fakepath)
  const base = filename.split('\\').pop().split('/').pop();
  // Remove .stl extension
  return base.replace(/\.stl$/i, '').trim();
}

function maybeAutoFillProjectNameFromStl(originalName) {
  const input = document.getElementById('project_name');
  if (!input) return;

  // Only auto-fill when empty or when we previously auto-filled it.
  if (input.value.trim() && !autoFilledProjectNameFromStl) return;

  const derived = deriveProjectNameFromFilename(originalName);
  if (!derived) return;

  input.value = derived;
  autoFilledProjectNameFromStl = true;
}

// If the user types, stop auto-overwriting.
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('project_name');
  if (!input) return;
  input.addEventListener('input', () => {
    autoFilledProjectNameFromStl = false;
  });

  // Re-analyze when material changes
  const materialSelect = document.getElementById('material_type');
  if (materialSelect) {
    materialSelect.addEventListener('change', () => {
      if (!uploadedStlFilename) return;
      reanalyzeStl();
    });
  }

  // Stop auto-overwrite on manual weight/time input
  const weightInput = document.getElementById('estimated_weight_grams');
  const timeInput   = document.getElementById('estimated_print_time_hours');
  if (weightInput) weightInput.addEventListener('input', () => { weightInput.dataset.autoFilled = ''; });
  if (timeInput)   timeInput.addEventListener('input', () => { timeInput.dataset.autoFilled = ''; });
});

async function reanalyzeStl() {
  const material = document.getElementById('material_type').value || 'PLA';
  const infill   = (document.getElementById('infill_percent').value || 20) / 100;
  try {
    const res = await fetch(
      `/api/print-requests/analyze-stl/${encodeURIComponent(uploadedStlFilename)}?material=${material}&infill=${infill}`,
      { headers: { 'Authorization': 'Bearer ' + getToken() } }
    );
    const data = await res.json();
    if (data.success && data.analysis) {
      showAnalysis(data.analysis);
    }
  } catch(e) {
    // silently ignore ‚Äî analysis is a nice-to-have
  }
}

function onInfillChange() {
  if (!uploadedStlFilename) return;
  reanalyzeStl();
}

function setStlStatus(msg, color) {
  const el = document.getElementById('stl-upload-status');
  el.textContent = msg;
  el.style.color = color || '#555';
}

function handleDrop(event) {
  event.preventDefault();
  const zone = document.getElementById('stl-drop-zone');
  zone.style.borderColor = '#ccc';
  zone.style.background = '';
  const file = event.dataTransfer.files[0];
  if (file) handleFileSelect(file);
}

function handleFileSelect(file) {
  if (!file) return;
  if (!file.name.toLowerCase().endsWith('.stl')) {
    setStlStatus('Only .stl files are allowed.', '#dc3545');
    return;
  }
  if (file.size > 50 * 1024 * 1024) {
    setStlStatus('File exceeds 50 MB limit.', '#dc3545');
    return;
  }
  uploadStlFile(file);
}

async function uploadStlFile(file) {
  setStlStatus('Uploading & analyzing‚Ä¶', '#888');

  const formData = new FormData();
  formData.append('file', file);
  // Pass selected material and infill so analysis uses correct parameters
  const material = document.getElementById('material_type').value || 'PLA';
  const infill   = (document.getElementById('infill_percent').value || 20) / 100;
  formData.append('material', material);
  formData.append('infill', infill);

  try {
    const res = await fetch('/api/print-requests/upload-stl', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + getToken() },
      body: formData
    });
    const data = await res.json();

    if (data.success) {
      uploadedStlFilename     = data.filename;
      uploadedStlOriginalName = data.original_name;

      maybeAutoFillProjectNameFromStl(uploadedStlOriginalName);

      document.getElementById('stl-drop-label').style.display   = 'none';
      document.getElementById('stl-file-selected').style.display = 'block';
      document.getElementById('stl-filename-display').textContent = data.original_name;
      setStlStatus('File uploaded successfully.', '#28a745');

      // Show analysis results if available
      if (data.analysis) {
        showAnalysis(data.analysis);
      }
    } else {
      setStlStatus(data.message || 'Upload failed.', '#dc3545');
    }
  } catch(e) {
    setStlStatus('Upload failed ‚Äî cannot reach server.', '#dc3545');
  }
}

function showAnalysis(a) {
  document.getElementById('stl-a-volume').textContent   = a.volume_cm3 + ' cm¬≥';
  document.getElementById('stl-a-weight').textContent   = a.estimated_weight_grams + ' g';
  document.getElementById('stl-a-time').textContent     = a.estimated_print_time_hours + ' h';
  document.getElementById('stl-a-material').textContent = a.material;
  document.getElementById('stl-a-infill').textContent   = a.infill_percent + '%';

  const bb = a.bounding_box;
  document.getElementById('stl-a-bbox').textContent =
    bb.x_mm + ' √ó ' + bb.y_mm + ' √ó ' + bb.z_mm + ' mm';

  document.getElementById('stl-analysis-card').style.display = 'block';

  // Auto-fill Est. Weight and Est. Print Time
  const weightInput = document.getElementById('estimated_weight_grams');
  const timeInput   = document.getElementById('estimated_print_time_hours');
  if (weightInput && (!weightInput.value || weightInput.dataset.autoFilled === 'true')) {
    weightInput.value = a.estimated_weight_grams;
    weightInput.dataset.autoFilled = 'true';
  }
  if (timeInput && (!timeInput.value || timeInput.dataset.autoFilled === 'true')) {
    timeInput.value = a.estimated_print_time_hours;
    timeInput.dataset.autoFilled = 'true';
  }
}

async function clearStlFile(event) {
  event.stopPropagation();

  const filenameToDelete = uploadedStlFilename;

  // Clear UI state immediately for a snappy UX.
  uploadedStlFilename     = null;
  uploadedStlOriginalName = null;
  autoFilledProjectNameFromStl = false;
  document.getElementById('stl-file-input').value = '';
  document.getElementById('stl-drop-label').style.display   = 'block';
  document.getElementById('stl-file-selected').style.display = 'none';
  document.getElementById('stl-analysis-card').style.display = 'none';
  setStlStatus('');

  // Clear auto-filled weight / time
  const weightInput = document.getElementById('estimated_weight_grams');
  const timeInput   = document.getElementById('estimated_print_time_hours');
  if (weightInput && weightInput.dataset.autoFilled === 'true') {
    weightInput.value = '';
    weightInput.dataset.autoFilled = '';
  }
  if (timeInput && timeInput.dataset.autoFilled === 'true') {
    timeInput.value = '';
    timeInput.dataset.autoFilled = '';
  }

  // Best-effort cleanup on the server.
  if (!filenameToDelete) return;
  try {
    await fetch(`/api/print-requests/upload-stl/${encodeURIComponent(filenameToDelete)}`, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + getToken() }
    });
  } catch (e) {
    // If server is unreachable, we still let the user proceed.
  }
}

// ‚îÄ‚îÄ Form submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAlert(msg, type='error') {
  document.getElementById('alert-box').innerHTML =
    `<div class="alert alert-${type}">${msg}</div>`;
}

async function doSubmit() {
  if (!uploadedStlFilename) { showAlert('Please upload an STL file.'); return; }

  const project_name = document.getElementById('project_name').value.trim();
  if (!project_name) { showAlert('Project name is required.'); return; }

  const body = {
    project_name,
    description:                document.getElementById('description').value.trim(),
    material_type:              document.getElementById('material_type').value,
    color_preference:           document.getElementById('color_preference').value.trim(),
    estimated_weight_grams:     parseFloat(document.getElementById('estimated_weight_grams').value) || null,
    estimated_print_time_hours: parseFloat(document.getElementById('estimated_print_time_hours').value) || null,
    priority:                   document.getElementById('priority').value,
    stl_file_path:              uploadedStlFilename    || null,
    stl_original_name:          uploadedStlOriginalName || null,
  };

  try {
    const res  = await apiFetch('/api/print-requests', { method: 'POST', body: JSON.stringify(body) });
    const data = await res.json();

    if (data.success) {
      submittedSuccessfully = true;
      showAlert('Request submitted successfully!', 'success');
      setTimeout(() => location.href = '/print-requests/', 1200);
    } else {
      showAlert(data.message || 'Submission failed.');
    }
  } catch(e) {
    showAlert('Cannot reach the backend.');
  }
}

// ‚îÄ‚îÄ Best-effort cleanup: if user leaves after uploading but before submitting ‚îÄ‚îÄ
window.addEventListener('beforeunload', () => {
  if (submittedSuccessfully) return;
  if (!uploadedStlFilename) return;

  const url = `/api/print-requests/upload-stl/${encodeURIComponent(uploadedStlFilename)}`;

  // Note: Browsers restrict what you can do during unload.
  // We try sendBeacon first; if not supported, fall back to fetch keepalive.
  try {
    if (navigator.sendBeacon) {
      // sendBeacon supports simple payloads; use JSON and backend ignores body.
      // We can't reliably set custom headers in sendBeacon, so this may be a no-op
      // depending on browser. keepalive fetch below often works better.
      navigator.sendBeacon(url, JSON.stringify({}));
    }
  } catch (e) {
    // ignore
  }

  try {
    fetch(url, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + getToken() },
      keepalive: true
    });
  } catch (e) {
    // ignore
  }
});
</script>
{% endblock %}
